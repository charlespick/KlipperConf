# This file contains macros for managing the 2 print carriages
# It is meant to be used with the other config files in this folder

[gcode_macro set_separation]
gcode: 
    {% set svv = printer.save_variables.variables %}

    {% set oldX = svv.xoffset|float %}
    {% set oldY = svv.yoffset|float %}
    {% set oldZ = svv.zoffset|float %}

    {% if params.X is defined %}
        SAVE_VARIABLE VARIABLE=xoffset VALUE={ params.X|float }
    {% endif %}

    {% if params.Y is defined %}
        SAVE_VARIABLE VARIABLE=yoffset VALUE={ params.Y|float }
    {% endif %}

    {% if params.Z is defined %}
        SAVE_VARIABLE VARIABLE=zoffset VALUE={ params.Z|float }
    {% endif %}

    {% if params.X_ADJUST is defined %}
        {% set newX = params.X_ADJUST|float + oldX %}
        SAVE_VARIABLE VARIABLE=xoffset VALUE={ newX|float }
    {% endif %}

    {% if params.Y_ADJUST is defined %}
        {% set newY = params.Y_ADJUST|float + oldY %}
        SAVE_VARIABLE VARIABLE=yoffset VALUE={ newY|float }
    {% endif %}

    {% if params.Z_ADJUST is defined %}
        {% set newZ = params.Z_ADJUST|float + oldZ %}
        SAVE_VARIABLE VARIABLE=yoffset VALUE={ newZ|float }
    {% endif %}

[gcode_macro calibrate_separation]
gcode: 
    G90 ; absolute
    M83 ; relative
    T0
    G1 X20       Y75      Z.2           F4800
    G1 X115                     E10
    G1           Y130           E10
    T1
    G1 X210      Y75
    G1 X115                     E10
    G1           Y20            E10
    present_bed

[gcode_macro PARK_extruder]
gcode:
    SET_DUAL_CARRIAGE CARRIAGE=0
    SAVE_GCODE_STATE NAME=park0
    SET_GCODE_OFFSET Y=0 X=0
    G90
    G1 X{ printer.toolhead.axis_minimum.x } F24000
    RESTORE_GCODE_STATE NAME=park0

[gcode_macro T0]
variable_offset_applied: 0
gcode:
    {% set svv = printer.save_variables.variables %}
    {% if "x" in printer.toolhead.homed_axes %}
        PARK_extruder1
    {% endif %}
    ACTIVATE_EXTRUDER EXTRUDER=extruder
    SET_DUAL_CARRIAGE CARRIAGE=0
    {% if printer["gcode_macro T0"].offset_applied == 1 %}
        SET_GCODE_OFFSET  X_ADJUST={ -(svv.xoffset) } Y_ADJUST={ -(svv.yoffset) } Z_ADJUST={ -(svv.zoffset) }
        SET_GCODE_VARIABLE MACRO=T0 VARIABLE=offset_applied VALUE=0
    {% endif %}
    SET_INPUT_SHAPER SHAPER_FREQ_X=39.0 SHAPER_FREQ_Y=40.2 SHAPER_TYPE_X=2hump_ei SHAPER_TYPE_Y=ei

[gcode_macro PARK_extruder1]
gcode:
    SET_DUAL_CARRIAGE CARRIAGE=1
    SAVE_GCODE_STATE NAME=park1
    SET_GCODE_OFFSET Y=0 X=0
    G90
    ;G1 X{ printer.toolhead.axis_maximum.x } F24000
    G1 X254 F24000
    RESTORE_GCODE_STATE NAME=park1

[gcode_macro T1]
gcode:
    {% set svv = printer.save_variables.variables %}
    {% if "x" in printer.toolhead.homed_axes %}
        PARK_extruder
    {% endif %}
    ACTIVATE_EXTRUDER EXTRUDER=extruder1
    SET_DUAL_CARRIAGE CARRIAGE=1
    {% if printer["gcode_macro T0"].offset_applied == 0 %}
        SET_GCODE_OFFSET  X_ADJUST={ svv.xoffset } Y_ADJUST={ svv.yoffset } Z_ADJUST={ svv.zoffset }
        SET_GCODE_VARIABLE MACRO=T0 VARIABLE=offset_applied VALUE=1
    {% endif %}
    SET_INPUT_SHAPER SHAPER_FREQ_X=55.6 SHAPER_FREQ_Y=31.0 SHAPER_TYPE_X=mzv SHAPER_TYPE_Y=mzv
